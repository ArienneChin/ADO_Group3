USE WAREHOUSE TRANSFER_ADO_ASSIGNMENT2_GROUP3;
USE DATABASE ADO_Assignment2_Group3;
USE SCHEMA RAW_DATASET; 

-------------- Remove Duplicate Records-----------------
CREATE OR REPLACE TABLE COPACASES_CLEAN AS 
SELECT *
FROM (
    SELECT 
        *,
        ROW_NUMBER() OVER (PARTITION BY LOG_NO ORDER BY COMPLAINT_DATE DESC) AS RN
    FROM COPACASES
)
WHERE RN = 1;

------------ Convert COMPLAINT_DATE to MM/DD/YYYY HH12:MI:SS AM ---------------------

CREATE OR REPLACE TABLE COPACASES_CLEAN AS  
SELECT
    LOG_NO,
    TRY_TO_TIMESTAMP(COMPLAINT_DATE, 'MM/DD/YYYY HH12:MI:SS AM') AS COMPLAINT_DATE, 
    ASSIGNMENT,
    CASE_TYPE,
    CURRENT_STATUS,
    CURRENT_CATEGORY,
    FINDING_CODE,
    POLICE_SHOOTING,
    BEAT,
    RACE_OF_COMPLAINANTS,
    SEX_OF_COMPLAINANTS,
    AGE_OF_COMPLAINANTS,
    RACE_OF_INVOLVED_OFFICERS,
    SEX_OF_INVOLVED_OFFICERS,
    AGE_OF_INVOLVED_OFFICERS,
    YEARS_ON_FORCE_OF_INVOLVED_OFFICERS,
    COMPLAINT_HOUR,
    COMPLAINT_DAY,
    COMPLAINT_MONTH
FROM COPACASES_CLEAN
WHERE TRY_TO_TIMESTAMP(COMPLAINT_DATE, 'MM/DD/YYYY HH12:MI:SS AM') IS NOT NULL;

-------------------------- clean missing value ----------------------------------

CREATE OR REPLACE TABLE COPACASES_CLEAN AS  
SELECT  
        LOG_NO,  
        COMPLAINT_DATE,  
        ASSIGNMENT,  
        CASE  
            WHEN CASE_TYPE IS NULL THEN 'Unknown'  
            ELSE CASE_TYPE  
        END AS CASE_TYPE, 
        COALESCE(CURRENT_STATUS, 'Unknown') AS CURRENT_STATUS,
        COALESCE(CURRENT_CATEGORY, 'Unknown') AS CURRENT_CATEGORY,
        COALESCE(FINDING_CODE, 'Unknown') AS FINDING_CODE,
        COALESCE(POLICE_SHOOTING, 'No') AS POLICE_SHOOTING,  
        COALESCE(BEAT, 'Unknown') AS BEAT,  
        COALESCE(RACE_OF_COMPLAINANTS, 'Unknown') AS RACE_OF_COMPLAINANTS,  
        COALESCE(SEX_OF_COMPLAINANTS, 'Unknown') AS SEX_OF_COMPLAINANTS,  
        COALESCE(AGE_OF_COMPLAINANTS, 'Unknown') AS AGE_OF_COMPLAINANTS,  
        COALESCE(RACE_OF_INVOLVED_OFFICERS, 'Unknown') AS RACE_OF_INVOLVED_OFFICERS,  
        COALESCE(SEX_OF_INVOLVED_OFFICERS, 'Unknown') AS SEX_OF_INVOLVED_OFFICERS,  
        COALESCE(AGE_OF_INVOLVED_OFFICERS, 'Unknown') AS AGE_OF_INVOLVED_OFFICERS,  
        COALESCE(YEARS_ON_FORCE_OF_INVOLVED_OFFICERS, 'Unknown') AS YEARS_ON_FORCE_OF_INVOLVED_OFFICERS,  
        COMPLAINT_HOUR,  
        COMPLAINT_DAY,  
        COMPLAINT_MONTH  
FROM COPACASES_CLEAN;

select * from COPACASES_CLEAN
