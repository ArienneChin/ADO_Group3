CREATE OR REPLACE TABLE CRIMES_PAST_YEAR_ARREST_MASTER AS
SELECT 
    c."CASE#" AS CRIME_CASE_NUMBER,
    c."DATE OF OCCURRENCE" AS CRIME_DATE,
    EXTRACT(DAY FROM c."DATE OF OCCURRENCE") AS CRIME_DAY,
    EXTRACT(MONTH FROM c."DATE OF OCCURRENCE") AS CRIME_MONTH,
    EXTRACT(YEAR FROM c."DATE OF OCCURRENCE") AS CRIME_YEAR,
    EXTRACT(HOUR FROM c."DATE OF OCCURRENCE") AS CRIME_HOUR,
    c."BLOCK" AS CRIME_BLOCK,
    c."PRIMARY DESCRIPTION" AS PRIMARY_CRIME_TYPE,
    c."SECONDARY DESCRIPTION" AS SECONDARY_CRIME_TYPE,
    c."LOCATION DESCRIPTION" AS LOCATION_OF_CRIME,
    c."ARREST" AS ARREST_MADE,
    c."DOMESTIC" AS DOMESTIC_INCIDENT,
    c."LATITUDE",
    c."LONGITUDE",
    ROUND(c."LATITUDE", 3) AS ROUNDED_LATITUDE,
    ROUND(c."LONGITUDE", 3) AS ROUNDED_LONGITUDE,
    COUNT(*) OVER (PARTITION BY c."LOCATION DESCRIPTION") AS TOTAL_CRIMES_AT_LOCATION,
    AVG(CASE WHEN c."ARREST" = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION BY c."PRIMARY DESCRIPTION") * 100 AS ARREST_RATE_PER_CRIME_TYPE,
    CASE 
        WHEN c."PRIMARY DESCRIPTION" IN ('HOMICIDE', 'AGGRAVATED BATTERY', 'ROBBERY') THEN 'Severe'
        WHEN c."PRIMARY DESCRIPTION" IN ('BURGLARY', 'THEFT', 'FRAUD') THEN 'Moderate'
        ELSE 'Low'
    END AS SEVERITY
FROM 
    CRIMES_PAST_YEAR_OCT_2024_CLEANED c
LEFT JOIN 
    ARRESTS a
    ON c."CASE#" = a."CASE NUMBER";
